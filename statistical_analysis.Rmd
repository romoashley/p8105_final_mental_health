---
title: "Statistical Analysis"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include = FALSE}
library(tidyverse)

tidydata = 
  read.csv("data/tidydata.csv")
```

## Independent Samples T-tests

We will first conduct independent samples t-tests to see if there is a statistical relationship between gender and two of our indicators of mental health access:

1. Took prescription medication and/or received counseling or therapy for mental health
2. Needed counseling or therapy for mental health but did not get it

Even though the independent samples t-test assumes normality, our sample size (50,000-90,000) is large. The Central Limit Theorem often allows the t-test to be used even when the population distribution is not normal, because the distribution of the sample means will tend to be normal.

P-values less than 0.05 will be considered as statistically significant.

### Took prescription medication and/or received counseling or therapy for mental health

The first independent samples t-test shows statistically significant differences in prescription medication and/or counseling or therapy for mental health rates. Men and women had statistically different mean rates of taking prescription medication for mental health and/or receiving counseling or therapy from 2020 to 2022 in the United States.

```{r}
gender_received =
  tidydata |>
  filter(
    indicator == "Took Prescription Medication for Mental Health And/Or Received Counseling or Therapy",
    state == "United States",
    group == "Sex",
    subgroup %in% c("Male", "Female")
  ) |>
 dplyr::select(week_number, value, subgroup) |>
  pivot_wider(
    names_from = "subgroup",
    values_from = "value") |>
  janitor::clean_names()

gender_received |>
  summarise(
    t_statistic = t.test(male, female)$statistic,
    p_value = t.test(male, female)$p.value) |>
  knitr::kable()
```

### Needed counseling or therapy but did not get it

The second independent samples t-test shows statistically significant differences in rates of needing counseling or therapy for mental health but not getting it. Men and women had statistically different mean rates of needing counseling or therapy for mental health but not getting it from 2020 to 2022 in the United States.

```{r}
gender_needed =
  tidydata |>
  filter(
    indicator == "Needed Counseling or Therapy But Did Not Get It",
    state == "United States",
    group == "Sex",
    subgroup %in% c("Male", "Female")
  ) |>
  dplyr::select(week_number, value, subgroup) |>
  pivot_wider(
    names_from = "subgroup",
    values_from = "value") |>
  janitor::clean_names()

gender_needed |>
  summarise(
    t_statistic = t.test(male, female)$statistic,
    p_value = t.test(male, female)$p.value) |>
  knitr::kable()
```

## ANOVA: sexual orientation

```{r}
sexuality_received =
  tidydata |>
  filter(
    indicator == "Took Prescription Medication for Mental Health And/Or Received Counseling or Therapy",
    state == "United States",
    group == "Sexual orientation",
    week_number %in% c(24:33)) |>
  dplyr::select(week_number, value, subgroup) |>
  pivot_wider(
    names_from = "subgroup",
    values_from = "value") |>
  janitor::clean_names()
```

```{r}
sexuality_needed =
  tidydata |>
  filter(
    indicator == "Needed Counseling or Therapy But Did Not Get It",
    state == "United States",
    group == "Sexual orientation",
    week_number %in% c(24:33)) |>
  group_by(subgroup)
```

## Check normality

```{r}

ggplot(tidydata, aes(sample = value)) +
  stat_qq() +
  stat_qq_line()

 hist(tidydata$value, breaks = "FD", main = "Histogram of Data", xlab = "Data Values")
```
The plot appears to be a Q-Q (quantile-quantile) plot showing that the data deviates from the expected normal distribution, particularly in the tails, indicating the presence of outliers or a heavy-tailed distribution.

The histogram illustrates a bimodal frequency distribution of data values, with significant concentrations of observations around two central peaks, suggesting the presence of two subpopulations within the dataset. The data range from near 0 to just over 60, with the majority of values clustered between 5 and 30, and a notable right skew indicating a tail of higher values extending towards 60. This skewness and the thinning bars towards the right may also point to the existence of outliers or extreme values in the dataset. The bimodal nature and the distribution's spread underscore the potential complexity within the data, hinting at varied underlying characteristics or groups.

```{r}
ggplot(tidydata, aes(sample = log(value))) +
  stat_qq() +
  stat_qq_line()

 hist(log(tidydata$value), breaks = "FD", main = "Histogram of Data", xlab = "Data Values")
```
Despite the application of a logarithmic transformation to the data, the resulting distribution does not conform to normality. This is evidenced by the Q-Q plot, which exhibits significant deviations from the line of normality, particularly in the tails. Such persistent non-normality suggests that the underlying data may not be log-normally distributed, or there may be influential outliers that resist transformation. Alternative transformations or non-parametric methods may be required to address these distributional issues.

```{r}
tidydata=tidydata |> mutate(subgroup=as.factor(subgroup),group=as.factor(group))
summary(pull(tidydata, value))
```
The summary statistics for the value dataset indicate a right-skewed distribution: the minimum value is 1.40, the first quartile is 10.30, the median is 16.20, and the third quartile is 24.00, with a considerably higher maximum value of 62.90. The mean, or average, is 17.45, which is higher than the median, further suggesting a distribution with a right tail. The broad range from the minimum to the maximum value points to a wide variation in the data, and the displacement of the mean towards the higher end of the range hints at the presence of outliers or a long tail to the right of the median.

## Kruskal-Wallis test

```{r}
kruskal_result=kruskal.test(value ~ subgroup, data = tidydata)
```

Kruskal-Wallis Chi-squared=1680.6. This is the test statistic that follows a chi-squared distribution under the null hypothesis. A value of 1680.6 is quite large, suggesting a significant difference.

The p-value is less than 2.2e-16. It effectively means that the p-value is extremely small, much less than the commonly used significance levels (like 0.05 or 0.01), indicating that there is a statistically significant difference in the medians across the groups.

In summary, the test result is highly significant, which leads to the rejection of the null hypothesis of equal medians. Therefore, we have sufficient evidence to say that not all group medians are equal.

# Continue Data Explore:

Now we are going to break down the dataset into four subgroups based the Indicator's categories. We are going to explore the distribution of each subgroup and perform the the most appropriate test.

```{r}
Indicator1=tidydata |> filter(indicator=="Took Prescription Medication for Mental Health")
Indicator2=tidydata |> filter(indicator=="Received Counseling or Therapy")
Indicator3=tidydata |> filter(indicator=="Took Prescription Medication for Mental Health And/Or Received Counseling or Therapy")
Indicator4=tidydata |> filter(indicator=="Needed Counseling or Therapy But Did Not Get It")
```

* Step 1: Check Normality for Group of people who Took Prescription Medication for Mental Health.

```{r}
shapiro_test_result <- shapiro.test(pull(Indicator1,value))

hist(log(Indicator1$value), breaks = "FD", main = "Histogram of Data", xlab = "Data Values")
Indicator1_log=Indicator1 |> mutate(value=log(value))
shapiro_test_result <- shapiro.test(pull(Indicator1_log,value))
```
Shapiro-Wilk normality test result : (W = 0.93709, p-value < 2.2e-16), The p-value is extremely small (< 2.2e-16), which provides strong evidence suggest that the data does not come from a normal distribution, and hence, we reject the null hypothesis of normality at 0.05 level of significance. 

The histogram looks a little bit like normal after I applied the log transformation. However, the shapiro wilk test's result is still significant to suggest this is not normally distributed.

* Step2: Perform Kruskal-Wallis test: 

```{r}
kruskal_result=kruskal.test(value ~ subgroup, data = Indicator1)
```

Kruskal-Wallis Chi-squared=1812.7. This is the test statistic that follows a chi-squared distribution under the null hypothesis. A value of 1812.7 is quite large, suggesting a significant difference.

The p-value is less than 2.2e-16. It effectively means that the p-value is extremely small, much less than the commonly used significance levels (like 0.05 or 0.01), indicating that there is a statistically significant difference in the medians across the groups.

In summary, the test result is highly significant, which leads to the rejection of the null hypothesis of equal medians. Therefore, we have sufficient evidence to say that not all group medians are equal.

* Step 3: Check normality for Group of people who Received Counseling or Therapy

```{r}
shapiro_test_result <- shapiro.test(pull(Indicator2,value))

hist(log(Indicator2$value), breaks = "FD", main = "Histogram of Data", xlab = "Data Values")
Indicator2_log=Indicator2 |> mutate(value=log(value))
shapiro_test_result <- shapiro.test(pull(Indicator2_log,value))
```
Shapiro-Wilk normality test result : (W = 0.83846, p-value < 2.2e-16), The p-value is extremely small (< 2.2e-16), which provides strong evidence suggest that the data does not come from a normal distribution, and hence, we reject the null hypothesis of normality at 0.05 level of significance. 

The histogram looks a little bit like normal after I applied the log transformation. However, the shapiro wilk test's result is still significant to suggest this is not normally distributed. 

* step 4: Perform Kruskal-Wallis test: 

```{r}
kruskal_result=kruskal.test(value ~ subgroup, data = Indicator2)
```

Kruskal-Wallis Chi-squared=1784.5. This is the test statistic that follows a chi-squared distribution under the null hypothesis. A value of 1784.5 is quite large, suggesting a significant difference.

The p-value is less than 2.2e-16. It effectively means that the p-value is extremely small, much less than the commonly used significance levels (like 0.05 or 0.01), indicating that there is a statistically significant difference in the medians across the groups.

In summary, the test result is highly significant, which leads to the rejection of the null hypothesis of equal medians. Therefore, we have sufficient evidence to say that not all group medians are equal.

* Step 5: Check normality for Group of people who Took Prescription Medication for Mental Health And/Or Received Counseling or Therapy

```{r}
shapiro_test_result <- shapiro.test(pull(Indicator3,value))

hist(log(Indicator3$value), breaks = "FD", main = "Histogram of Data", xlab = "Data Values")
Indicator3_log=Indicator3 |> mutate(value=log(value))
shapiro_test_result <- shapiro.test(pull(Indicator3_log,value))
```
Shapiro-Wilk normality test result : (W = 0.95871, p-value < 2.2e-16), The p-value is extremely small (< 2.2e-16), which provides strong evidence suggest that the data does not come from a normal distribution, and hence, we reject the null hypothesis of normality at 0.05 level of significance. 

The histogram looks a little bit like normal after I applied the log transformation. However, the shapiro wilk test's result is still significant to suggest this is not normally distributed. 


